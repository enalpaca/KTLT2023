@using System.Web;
@{
    ViewData["Title"] = "Danh sách mặt hàng";
}

<h1>@ViewData["Title"]</h1>

<form method="post" action="Product/SearchProduct">
    <div class="input-group mb-3">
        <input type="text" class="form-control" value="@ViewBag.searchText" name="searchText" placeholder="Tìm mã hàng, mặt hàng ..." aria-label="Tìm mã hàng, mặt hàng ..." aria-describedby="button-addon2">
        <button class="btn btn-outline-secondary" type="submit" id="button-addon2">Tìm</button>
    </div>
</form>

<h2>Tổng cộng: @ViewBag.ProductCount</h2>

<div class="mb-3">
    <form style="display: inline" action="/Product/CreateProduct" method="get">
        <button class="btn btn-primary">Thêm mới mặt hàng</button>
    </form>
</div>

<div class="table-responsive">
    <table class="table table-striped table-bordered">
        <tr>
            <th>Mã</th>
            <th>Tên hàng</th>
            <th>Hạn dùng</th>
            <th>Công ty sản xuất</th>
            <th>Ngày sản xuất</th>
            <th>Loại hàng</th>
            <th>Giá</th>
            <th>Số lượng tồn kho</th>
            <th>Hành động</th>
        </tr>
        @foreach (var item in ViewBag.ProductList)
        {
            <tr>
                <td>@item.ProductCode</td>
                <td>@item.ProductName</td>
                <td>@item.ProductExpiredAt.ToString("yyyy-MM-dd")</td>
                <td>@item.ProductCompany</td>
                <td>@item.ProductProductionDate.ToString("yyyy-MM-dd")</td>
                <td>@item.ProductCategoryName</td>
                <td>@item.ProductPrice.ToString("#,##0")</td>
                <td>@item.ProductQuantity</td>
                <td>

                    <div class="btn-group m-1" role="group" aria-label="First group">
                        <a href="/Product/EditProduct?ProductCode=@item.ProductCode"><button type="button" class="btn btn-warning">Sửa</button></a>
                    </div>

                    <div class="btn-group m-1" role="group" aria-label="Third group">
                        <form method="post" action="Product/DeleteProduct?ProductCode=@item.ProductCode">
                            <input class="btn btn-danger" type="submit" value="Xóa">
                        </form>
                    </div>
                </td>
            </tr>
        }
    </table>

    @{
        int totalPage = ViewBag.totalPage;
        int currentPage = ViewBag.currentPage;

        var currentQueryString = this.Context.Request.QueryString;

        // Thêm, sữa query string Ref: https://trackjs.com/blog/query-string-parsing/
        var newQueryString = HttpUtility.ParseQueryString(currentQueryString.ToString());

        // lấy 3 page để render
        int page1 = 0;
        int page2 = 0;
        int page3 = 0;

        if (totalPage == 1)
        {
            page1 = 1;
        }

        if (totalPage == 2)
        {
            page1 = 1;
            page2 = 2;
        }

        if (totalPage == 3)
        {
            page1 = 1;
            page2 = 2;
            page3 = 3;
        }

        if (totalPage > 3)
        {
            page2 = currentPage;
            page1 = currentPage - 1;
            page3 = currentPage + 1;

            if (currentPage == 1)
            {
                page3 = currentPage + 2;
                page2 = currentPage + 1;
                page1 = currentPage;
            }

            if (currentPage == totalPage)
            {
                page3 = currentPage;
                page2 = currentPage - 1;
                page1 = currentPage - 2;
            }
        }

        string page1Active = page1 == currentPage ? "active" : "";
        string page2Active = page2 == currentPage ? "active" : "";
        string page3Active = page3 == currentPage ? "active" : "";

        string backDisabled = currentPage == 1 ? "disabled" : "";
        string toDisabled = currentPage == totalPage ? "disabled" : "";

        if (currentPage > totalPage)
        {
            toDisabled = "disabled";
        }

        newQueryString["page"] = $"{currentPage - 1}";
        string backPageUrl = $"Product?{newQueryString}";

        newQueryString["page"] = $"{currentPage + 1}";
        string toPageUrl = $"Product?{newQueryString}";

        newQueryString["page"] = $"{page1}";
        string page1Url = $"Product?{newQueryString}";

        newQueryString["page"] = $"{page2}";
        string page2Url = $"Product?{newQueryString}";

        newQueryString["page"] = $"{page3}";
        string page3Url = $"Product?{newQueryString}";
    }
    <nav>
        <ul class="pagination">
            <li class="page-item @backDisabled">
                <a class="page-link" href="@backPageUrl">Trang trước</a>
            </li>
            @if (page1 > 0)
            {
                <li class="page-item @page1Active"><a class="page-link" href="@page1Url">@page1</a></li>
            }

            @if (page2 > 0)
            {
                <li class="page-item @page2Active">
                    <a class="page-link" href="@page2Url">@page2</a>
                </li>
            }
            @if (page3 > 0)
            {
                <li class="page-item @page3Active">
                    <a class="page-link" href="@page3Url">@page3</a>
                </li>
            }
            <li class="page-item @toDisabled">
                <a class="page-link" href="@toPageUrl">Trang sau</a>
            </li>
        </ul>
    </nav>
</div>